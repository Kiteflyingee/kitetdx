name: Publish to PyPI

on:
  release:
    types: [published]
  # 也可以手动触发方便测试
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    environment: pypi
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      # ------------------------------------------------------------------
      # 修复部分：使用 pipx 代替 curl 脚本
      # pipx 预装在 GitHub Actions 中，更稳定，且自动处理 PATH 问题
      # ------------------------------------------------------------------
      - name: Install Poetry
        run: pipx install poetry==2.3.0

      # ✅ 直接安装依赖（Poetry 会自动创建一个干净的虚拟环境）
      - name: Install dependencies
        run: poetry install --no-interaction --no-root

      # ✅ Build 和 Publish 会自动使用上面创建的环境
      - name: Build package
        run: poetry build

      - name: Publish to PyPI
        run: poetry publish
        env:
          POETRY_PYPI_TOKEN_PYPI: ${{ secrets.PYPI_TOKEN }}
